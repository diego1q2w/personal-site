#!/usr/bin/env bash
set -e

SRC="site"
BASE_PATH="../site"
TF_FILE="./terraform/files.tf"
COUNT=0

header=$(cat <<'EOF'
# This file is generated by ./script/files.
# Any changes WILL be overwritten!
EOF
)

echo "$header" > $TF_FILE

find $SRC -iname '*.*' | sort | while read path; do

    cat >> $TF_FILE << EOM

resource "aws_s3_bucket_object" "file_$COUNT" {
  bucket       = aws_s3_bucket.static_site.bucket
  key          = "${path#$SRC}"
  source       = "$BASE_PATH${path#$SRC}"
  content_type = lookup(var.mime_types, "${path##*.}")
  etag         = filebase64sha256("$BASE_PATH${path#$SRC}")
}
EOM

    COUNT=$(expr $COUNT + 1)

done